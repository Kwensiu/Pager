<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç®€å•Sessionæµ‹è¯•</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #f0f0f0;
      }
      .test-area {
        background: white;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      button {
        padding: 10px;
        margin: 5px;
        background: #007acc;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .result {
        background: #f8f8f8;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” ç®€å•Sessionæµ‹è¯•</h1>

    <div class="test-area">
      <h3>å½“å‰ç¯å¢ƒ</h3>
      <div id="environment"></div>
    </div>

    <div class="test-area">
      <h3>Cookieæµ‹è¯•</h3>
      <button onclick="setCookie()">è®¾ç½®Cookie</button>
      <button onclick="getCookie()">è·å–Cookie</button>
      <button onclick="clearCookie()">æ¸…é™¤Cookie</button>
      <div id="cookie-result" class="result"></div>
    </div>

    <div class="test-area">
      <h3>LocalStorageæµ‹è¯•</h3>
      <button onclick="setStorage()">è®¾ç½®Storage</button>
      <button onclick="getStorage()">è·å–Storage</button>
      <button onclick="clearStorage()">æ¸…é™¤Storage</button>
      <div id="storage-result" class="result"></div>
    </div>

    <div class="test-area">
      <h3>è·¨åŸŸæ£€æŸ¥</h3>
      <button onclick="checkCrossDomain()">æ£€æŸ¥å…¶ä»–åŸŸæ•°æ®</button>
      <div id="cross-result" class="result"></div>
    </div>

    <script>
      function showEnvironment() {
        const env = {
          hostname: window.location.hostname,
          href: window.location.href,
          origin: window.location.origin,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        }
        document.getElementById('environment').textContent = JSON.stringify(env, null, 2)
      }

      function setCookie() {
        const value = `test_${window.location.hostname}_${Date.now()}`
        document.cookie = `simple_test=${value}; path=/; max-age=3600`
        document.getElementById('cookie-result').textContent = `å·²è®¾ç½®Cookie: ${value}`
      }

      function getCookie() {
        const cookies = document.cookie
          .split(';')
          .map((c) => c.trim())
          .filter((c) => c.length > 0)
        const testCookies = cookies.filter((c) => c.includes('simple_test'))
        document.getElementById('cookie-result').textContent =
          `æ‰€æœ‰Cookie (${cookies.length}ä¸ª):\n${cookies.join('\n')}\n\næµ‹è¯•Cookie:\n${testCookies.join('\n')}`
      }

      function clearCookie() {
        const cookies = document.cookie.split(';')
        cookies.forEach((cookie) => {
          const name = cookie.split('=')[0]
          document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`
        })
        document.getElementById('cookie-result').textContent = 'å·²æ¸…é™¤æ‰€æœ‰Cookie'
      }

      function setStorage() {
        const value = {
          domain: window.location.hostname,
          timestamp: Date.now(),
          test: 'simple_test'
        }
        localStorage.setItem('simple_test', JSON.stringify(value))
        document.getElementById('storage-result').textContent =
          `å·²è®¾ç½®Storage: ${JSON.stringify(value)}`
      }

      function getStorage() {
        const allKeys = Object.keys(localStorage)
        const testData = localStorage.getItem('simple_test')
        let result = `æ‰€æœ‰Storageé”® (${allKeys.length}ä¸ª):\n${allKeys.join('\n')}\n\n`
        result += `æµ‹è¯•æ•°æ®:\n${testData || 'æœªæ‰¾åˆ°'}`

        // æ£€æŸ¥å…¶ä»–åŸŸçš„æ•°æ®
        const crossDomainData = allKeys.filter(
          (key) => key.includes('simple_test') && !key.includes(window.location.hostname)
        )

        if (crossDomainData.length > 0) {
          result += `\n\nâš ï¸ å‘ç°è·¨åŸŸæ•°æ®:\n${crossDomainData.join('\n')}`
        } else {
          result += '\n\nâœ… æœªå‘ç°è·¨åŸŸæ•°æ®'
        }

        document.getElementById('storage-result').textContent = result
      }

      function clearStorage() {
        localStorage.clear()
        document.getElementById('storage-result').textContent = 'å·²æ¸…é™¤æ‰€æœ‰Storage'
      }

      function checkCrossDomain() {
        // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è·¨åŸŸæ•°æ®
        const cookies = document.cookie.split(';').map((c) => c.trim())
        const storageKeys = Object.keys(localStorage)

        const cookieDomains = []
        const storageDomains = []

        cookies.forEach((cookie) => {
          if (cookie.includes('simple_test')) {
            const value = cookie.split('=')[1]
            const domain = value.split('_')[1]
            if (domain && domain !== window.location.hostname) {
              cookieDomains.push(domain)
            }
          }
        })

        storageKeys.forEach((key) => {
          if (key.includes('simple_test')) {
            try {
              const data = JSON.parse(localStorage.getItem(key))
              if (data.domain && data.domain !== window.location.hostname) {
                storageDomains.push(data.domain)
              }
            } catch (e) {
              // ignore parse errors
            }
          }
        })

        const result = {
          currentDomain: window.location.hostname,
          crossDomainCookies: cookieDomains,
          crossDomainStorage: storageDomains,
          isIsolated: cookieDomains.length === 0 && storageDomains.length === 0
        }

        document.getElementById('cross-result').textContent =
          `è·¨åŸŸæ£€æŸ¥ç»“æœ:\n${JSON.stringify(result, null, 2)}`
      }

      // åˆå§‹åŒ–
      showEnvironment()
    </script>
  </body>
</html>
